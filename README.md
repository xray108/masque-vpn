# masque-vpn

[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/iselt/masque-vpn)

VPN-реализация на основе протокола MASQUE (CONNECT-IP) с использованием транспорта QUIC.

**⚠️ Этот проект находится на ранней стадии разработки и не готов для использования в продакшене. Он предназначен для образовательных целей и демонстрации протокола MASQUE.**

**Этот проект включает подмодуль `connect-ip-go`. Пожалуйста, клонируйте репозиторий с флагом `--recurse-submodules`:**

```bash
git clone --recurse-submodules https://github.com/twogc/masque-vpn.git
```

Или если вы используете оригинальный репозиторий:

```bash
git clone --recurse-submodules https://github.com/iselt/masque-vpn.git
```

## Возможности

- **Современные протоколы**: Построен на QUIC и MASQUE CONNECT-IP
- **Взаимная TLS-аутентификация**: Аутентификация клиент-сервер на основе сертификатов
- **Веб-интерфейс управления**: Управление клиентами и конфигурацией через браузер
- **Кроссплатформенность**: Поддержка Windows, Linux и macOS
- **Управление пулом IP**: Автоматическое выделение IP-адресов клиентам и маршрутизация
- **FEC (Forward Error Correction)**: Упреждающая коррекция ошибок для повышения стабильности в сетях с потерями
- **Мониторинг**: Встроенная поддержка Prometheus и дашборды Grafana
- **Мониторинг в реальном времени**: Статус подключений клиентов в реальном времени

## Документация

Мы подготовили подробную документацию для студентов и исследователей:

- **[Руководство студента](docs/development/student-guide.ru.md)**: Инструкции по запуску, лабораторные работы и эксперименты.
- **[Архитектура](docs/architecture/architecture.ru.md)**: Описание компонентов и потоков данных.
- **[API Документация](docs/api/api.ru.md)**: Описание HTTP API для управления и мониторинга.
- **[Мониторинг](docs/monitoring/setup.ru.md)**: Настройка Prometheus и Grafana.

## Архитектура

Система состоит из:
- **VPN-сервер**: Обрабатывает подключения клиентов и маршрутизацию трафика
- **VPN-клиент**: Подключается к серверу и маршрутизирует локальный трафик
- **Веб-интерфейс**: Интерфейс управления сертификатами и клиентами
- **Система сертификатов**: PKI-аутентификация с использованием взаимного TLS

## Быстрый старт

### 1. Сборка

```bash
cd vpn_client && go build
cd ../vpn_server && go build
cd ../admin_webui && npm install && npm run build
```

### 2. Настройка сертификатов

```bash
cd vpn_server/cert
# Генерация CA-сертификата
sh gen_ca.sh
# Генерация серверного сертификата
sh gen_server_keypair.sh
```

### 3. Конфигурация сервера

Скопируйте и отредактируйте конфигурацию сервера:
```bash
cp vpn_server/config.server.toml.example vpn_server/config.server.toml
```

### 4. Запуск сервера

```bash
cd vpn_server
sudo ./vpn-server
```

> **Примечание для macOS**: На macOS требуются права администратора для создания TUN-устройства.

### 5. Веб-управление

- Адрес: `http://<server-ip>:8080/`
- Учетные данные по умолчанию: `admin` / `admin`
- Генерируйте конфигурации клиентов через веб-интерфейс

### 6. Запуск клиента

```bash
cd vpn_client
sudo ./vpn-client
```

## Конфигурация

### Конфигурация сервера

Основные параметры в `config.server.toml`:

| Параметр | Описание | Пример |
|----------|----------|--------|
| `listen_addr` | Адрес прослушивания сервера | `"0.0.0.0:4433"` |
| `assign_cidr` | Диапазон IP для клиентов | `"10.0.0.0/24"` |
| `advertise_routes` | Маршруты для анонсирования | `["0.0.0.0/0"]` |
| `cert_file` | Путь к серверному сертификату | `"cert/server.crt"` |
| `key_file` | Путь к приватному ключу сервера | `"cert/server.key"` |

### Конфигурация клиента

Генерируется автоматически через веб-интерфейс или настраивается вручную:

| Параметр | Описание |
|----------|----------|
| `server_addr` | Адрес VPN-сервера |
| `server_name` | Имя сервера для TLS |
| `ca_pem` | CA-сертификат (встроенный) |
| `cert_pem` | Клиентский сертификат (встроенный) |
| `key_pem` | Приватный ключ клиента (встроенный) |

## Веб-интерфейс управления

Веб-интерфейс предоставляет:

- **Управление клиентами**: Генерация, загрузка и удаление конфигураций клиентов
- **Мониторинг в реальном времени**: Просмотр подключенных клиентов и их IP-адресов
- **Управление сертификатами**: Автоматическая генерация и распространение сертификатов
- **Конфигурация**: Управление настройками сервера

## Технические детали

### Зависимости

- **QUIC**: [quic-go](https://github.com/quic-go/quic-go) - реализация протокола QUIC
- **MASQUE**: [connect-ip-go](https://github.com/quic-go/connect-ip-go) - протокол MASQUE CONNECT-IP
- **База данных**: SQLite для хранения клиентов и конфигурации
- **TUN**: Кроссплатформенное управление TUN-устройствами

### Безопасность

- **Взаимный TLS**: Клиент и сервер аутентифицируются с использованием сертификатов
- **Центр сертификации**: Самоподписанный CA для управления сертификатами
- **Уникальные ID клиентов**: Каждый клиент имеет уникальный идентификатор
- **Изоляция IP**: Клиенты получают индивидуальные IP-адреса

## Разработка

### Структура проекта

```
masque-vpn/
├── common/           # Общий код и утилиты
├── vpn_client/       # Реализация клиента
├── vpn_server/       # Реализация сервера
│   └── cert/         # Скрипты генерации сертификатов
├── admin_webui/      # Ресурсы веб-интерфейса
└── README.md
```

### Сборка из исходников

Требования:
- Go 1.25.0 или новее
- OpenSSL (для генерации сертификатов)
- Node.js и npm (для веб-интерфейса)

## Решение проблем

### Распространенные проблемы

1. **Ошибки сертификатов**: Убедитесь, что CA и сертификаты правильно сгенерированы
2. **Проблемы с правами**: Создание TUN-устройства требует прав администратора
3. **Firewall**: Убедитесь, что порт сервера (по умолчанию 4433) доступен
4. **Проблемы с MTU**: Настройте параметры MTU при проблемах с подключением

### Проблемы на macOS

На macOS могут возникать специфические проблемы с TUN-устройствами:

1. **"Destination address required"**: Исправлено в текущей версии - TUN-устройства на macOS требуют point-to-point конфигурации
2. **"Slice bounds out of range"**: Исправлено - WireGuard TUN на macOS требует минимум 4 байта offset

#### Техническая информация

**Point-to-Point интерфейсы**

TUN-устройства на macOS создают виртуальный туннель между двумя точками:
- **Сервер (local)**: gateway IP (например, 10.0.0.1)
- **Клиент (destination)**: следующий IP (например, 10.0.0.2)

Метод `Next()` из пакета `netip` возвращает следующий IP-адрес:
- `10.0.0.1.Next()` → `10.0.0.2`
- `192.168.1.1.Next()` → `192.168.1.2`

**WireGuard TUN Offset**

WireGuard TUN на macOS использует offset для размещения служебной информации:
- **4 байта** - минимальный offset для macOS
- **10 байт** - используется в `proxy.go` (VirtioNetHdrLen)

Offset указывает, с какой позиции в буфере начинаются данные пакета. Библиотека записывает заголовок перед этой позицией:

```
Буфер: [header (4 bytes)][packet data (n bytes)]
                         ^
                         offset=4
```

**Совместимость**

Эти исправления специфичны для macOS и не влияют на работу на других платформах:
- **Linux**: использует `tun_linux.go`
- **Windows**: использует `tun_windows.go`


## Участие в разработке

Этот проект создан в образовательных целях. Приветствуются вклады в:
- Улучшения протокола
- Кроссплатформенная совместимость
- Улучшения документации
- Исправления ошибок

## Ссылки

- [Спецификация протокола MASQUE](https://datatracker.ietf.org/doc/draft-ietf-masque-connect-ip/)
- [Протокол QUIC](https://datatracker.ietf.org/doc/rfc9000/)
- [Библиотека quic-go](https://github.com/quic-go/quic-go)
- [Библиотека connect-ip-go](https://github.com/quic-go/connect-ip-go)

### Стандарты и RFC

- **MASQUE CONNECT-IP**: [RFC 9484](https://datatracker.ietf.org/doc/html/rfc9484) - Проксирование IP в HTTP
- **MASQUE CONNECT-UDP**: [RFC 9298](https://datatracker.ietf.org/doc/html/rfc9298) - Проксирование UDP в HTTP
- **QUIC Transport**: [RFC 9000](https://datatracker.ietf.org/doc/html/rfc9000) - QUIC: Мультиплексированный и защищенный транспорт на основе UDP
- **HTTP Datagrams**: [RFC 9297](https://datatracker.ietf.org/doc/html/rfc9297) - HTTP-датаграммы и протокол Capsule

Этот проект построен на следующих библиотеках с открытым исходным кодом:

* [quic-go](https://github.com/quic-go/quic-go) - Реализация QUIC на Go
* [connect-ip-go](https://github.com/quic-go/connect-ip-go) - Реализация протокола MASQUE CONNECT-IP на Go

## Для студентов и исследователей вузов

Этот проект является частью образовательных материалов для курсов университетов по современным сетевым протоколам для автономных систем (БАС - беспилотные авиационные системы).

### Связь с учебной программой вузов

Эта реализация демонстрирует **MASQUE CONNECT-IP (RFC 9484)** - современный протокол для туннелирования IP-пакетов через HTTP/3 (QUIC), который рассматривается в курсах вузов «Кадры для автономных систем».

**Ресурсы курса:**
- Курс на OpenEdu: [openedu.mpei.ru/course/BAS_2](https://openedu.mpei.ru/course/BAS_2)
- Федеральный проект: «Кадры для автономных систем»

### Почему MASQUE для автономных систем?

MASQUE CONNECT-IP решает критические проблемы связности для автономных систем:

1. **Обход корпоративных сетей**: Многие корпоративные сети блокируют UDP-трафик. MASQUE туннелирует IP-пакеты через QUIC (UDP:443), делая их похожими на HTTPS-трафик и обходя файрволы.

2. **Оптимизация для мобильных сетей**: Встроенные возможности QUIC (0-RTT, миграция соединений, мультиплексирование) обеспечивают лучшую производительность, чем традиционные VPN-протоколы в мобильных сценариях.

3. **Основан на стандартах**: В отличие от проприетарных VPN-решений, MASQUE является стандартом IETF (RFC 9484), обеспечивающим совместимость и будущую поддержку.

### Темы исследований для студентов

Этот проект может служить основой для дипломных работ, исследовательских проектов или лабораторных заданий:

#### 1. Анализ производительности
- Сравнение производительности MASQUE VPN с традиционными VPN-протоколами (OpenVPN, WireGuard)
- Измерение задержки, пропускной способности и джиттера в различных сетевых условиях
- Анализ влияния миграции соединений QUIC на стабильность VPN

#### 2. Оценка безопасности
- Оценка реализации взаимной TLS-аутентификации
- Анализ управления сертификатами и безопасности PKI
- Изучение механизмов защиты от повторов для 0-RTT соединений

#### 3. Оптимизация сети
- Реализация и тестирование управления перегрузкой BBRv3 для MASQUE-туннелей
- Оптимизация управления пулом IP и алгоритмов маршрутизации
- Изучение влияния потери пакетов на производительность VPN

#### 4. Интеграция с автономными системами
- Интеграция MASQUE VPN с наземными станциями управления
- Реализация предсказания хэндовера для мобильных сценариев
- Разработка механизмов отказоустойчивости для критических соединений

#### 5. Расширения протокола
- Реализация дополнительных функций MASQUE (CONNECT-UDP для специфических случаев)
- Добавление поддержки IPv6-туннелирования
- Интеграция с системами маршрутизации на основе ИИ

### Лабораторные задания

**Базовый уровень:**
1. Настройка MASQUE VPN сервера и клиента
2. Конфигурация аутентификации на основе сертификатов
3. Тестирование связности через корпоративные файрволы
4. Мониторинг метрик соединения (задержка, пропускная способность)

**Продвинутый уровень:**
1. Реализация пользовательских политик маршрутизации
2. Добавление мониторинга производительности и сбора метрик
3. Интеграция с инструментами эмуляции сети (tc, netem)
4. Сравнение производительности с традиционными VPN-решениями

**Исследовательский уровень:**
1. Реализация и тестирование оптимизаций протокола
2. Разработка и оценка новых функций
3. Публикация результатов на академических конференциях
4. Внесение улучшений обратно в проект

### Начало работы для исследований

1. **Форк репозитория**: Создайте свой форк для экспериментов
2. **Изучите код**: Разберитесь с архитектурой в `vpn_server/` и `vpn_client/`
3. **Настройте тестовое окружение**: Используйте эмуляцию сети для симуляции различных условий
4. **Собирайте метрики**: Реализуйте логирование и мониторинг для вашего исследования
5. **Документируйте результаты**: Пишите отчеты, сравнивающие различные конфигурации

### Контакты и сотрудничество

По вопросам использования этого проекта в исследованиях вузов:
- Проверьте оригинальный репозиторий: [iselt/masque-vpn](https://github.com/iselt/masque-vpn)

### Связанные проекты

- [CloudBridge QUIC Test Suite](https://github.com/twogc/quic-test) - Тестирование и бенчмаркинг протокола QUIC
- [CloudBridge Research](https://cloudbridge-research.ru) - Исследовательская документация и публикации

## Документация на других языках

- [English](README_en.md) - English documentation
- [中文文档](README_zh.md) - Chinese documentation
