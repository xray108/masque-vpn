# Руководство студента: Использование masque-vpn для исследований

Это руководство поможет студентам вузов использовать masque-vpn для исследовательских проектов, дипломных работ и лабораторных заданий.

## Обзор

masque-vpn реализует протокол MASQUE CONNECT-IP (RFC 9484) для туннелирования IP-пакетов через HTTP/3 (QUIC). Это делает его идеальным инструментом для изучения современных сетевых протоколов и сравнения производительности VPN.

## Предварительные требования

- Базовое понимание принципов работы VPN
- Знакомство с протоколом QUIC (см. материалы курса)
- Основы языка программирования Go
- Опыт работы с командной строкой Linux/macOS

## Начало работы

### 1. Сборка и развертывание

```bash
# Клонирование репозитория
git clone --recurse-submodules https://github.com/twogc/masque-vpn.git
cd masque-vpn

# Сборка сервера и клиента
cd vpn_server && go build -o vpn-server
cd ../vpn_client && go build -o vpn-client
```

### 2. Настройка сервера

```bash
cd vpn_server
cp config.server.toml.example config.server.toml
# Отредактируйте config.server.toml по необходимости
```

Ключевые параметры конфигурации:
- `listen_addr`: Адрес прослушивания сервера (по умолчанию: "0.0.0.0:4433")
- `assign_cidr`: Диапазон IP-адресов для клиентов (по умолчанию: "10.0.0.0/24")
- `advertise_routes`: Маршруты, анонсируемые клиентам (по умолчанию: ["0.0.0.0/0"])

### 3. Генерация сертификатов

```bash
cd cert
sh gen_ca.sh
sh gen_server_keypair.sh
```

### 4. Запуск сервера

```bash
cd ..
sudo ./vpn-server
```

### 5. Генерация конфигурации клиента

Откройте веб-интерфейс по адресу http://localhost:8080 (логин/пароль: admin/admin) и сгенерируйте конфигурацию для клиента.

### 6. Тестирование базовой функциональности

```bash
# Тест функциональности протокола MASQUE
go run test_masque_connection.go

# Проверка API endpoints
curl http://127.0.0.1:8080/health
curl http://127.0.0.1:8080/api/v1/status
```

## Сценарии исследований

### Анализ протокола

Изучение кастомной реализации MASQUE CONNECT-IP:

1. **Кастомная реализация**: Анализ реализации MASQUE в `common/masque_connectip.go`
2. **Поток пакетов**: Изучение обработки пакетов в `vpn_server/internal/server/masque_handler.go`
3. **Интеграция с QUIC**: Исследование использования QUIC streams для туннелирования IP пакетов
4. **Обработка ошибок**: Изучение централизованной системы ошибок в `common/errors.go`

### Анализ производительности

Сравнение MASQUE VPN с традиционными протоколами VPN:

1. **Измерение задержки**: Используйте ping для измерения RTT через VPN.
2. **Тестирование пропускной способности**: Используйте iperf3 для измерения скорости.
3. **Анализ потери пакетов**: Отслеживайте потерю пакетов в различных сетевых условиях.

### Симуляция сети

Тестирование поведения VPN в различных сетевых условиях с помощью tc/netem:

```bash
# Добавить задержку 100 мс
sudo tc qdisc add dev eth0 root netem delay 100ms

# Добавить 10% потерю пакетов
sudo tc qdisc add dev eth0 root netem loss 10%

# Ограничить пропускную способность
sudo tc qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms
```

### Сбор метрик

Используя встроенные метрики Prometheus для анализа:

```bash
# Просмотр доступных метрик
curl http://127.0.0.1:8080/metrics

# Мониторинг активных соединений
curl http://127.0.0.1:8080/api/v1/status

# Просмотр статистики клиентов
curl http://127.0.0.1:8080/api/v1/clients
```

См. [monitoring/setup.md](../monitoring/setup.md) для настройки дашборда Grafana.

## Лабораторные работы

### Лабораторная работа 1: Базовое развертывание

**Цель**: Развернуть и протестировать masque-vpn.

**Задачи**:
1. Собрать сервер и клиент.
2. Настроить сертификаты.
3. Установить VPN-соединение.
4. Проверить связность (ping).

**Продолжительность**: 2-3 часа

### Лабораторная работа 2: Тестирование производительности

**Цель**: Измерить производительность VPN.

**Задачи**:
1. Измерить базовую задержку и пропускную способность.
2. Сравнить с прямым подключением (без VPN).
3. Протестировать работу в условиях плохой сети (потери, задержки).
4. Проанализировать результаты.

**Продолжительность**: 3-4 часа

### Лабораторная работа 3: Анализ протокола

**Цель**: Понять поведение протокола MASQUE.

**Задачи**:
1. Захватить трафик QUIC с помощью Wireshark.
2. Проанализировать структуру пакетов.
3. Определить специфичные для MASQUE особенности.
4. Сравнить с обычным трафиком HTTP/3.

**Продолжительность**: 4-5 часов

### Лабораторная работа 4: Анализ производительности под нагрузкой

**Цель**: Изучить поведение VPN при различных сетевых условиях.

**Задачи**:
1. Настроить эмуляцию сетевых условий с помощью `tc` (Linux).
2. Протестировать работу с различными уровнями задержки (10ms, 100ms, 500ms).
3. Протестировать работу с потерей пакетов (1%, 5%, 10%).
4. Протестировать работу с ограничением пропускной способности.
5. Проанализировать влияние условий на производительность.
6. Изучить метрики восстановления соединений в API.

**Продолжительность**: 3-4 часа

## Темы дипломных работ

### Тема 1: Оптимизация производительности

**Название**: "Оптимизация производительности MASQUE CONNECT-IP реализации"

**Объем работ**:
- Анализ узких мест текущей реализации.
- Реализация улучшений производительности.
- Сравнительный анализ с другими VPN протоколами.
- Измерение и документирование улучшений.

**Продолжительность**: 4-6 месяцев

### Тема 2: Мониторинг и аналитика

**Название**: "Система мониторинга и аналитики для VPN на базе протокола MASQUE"

**Объем работ**:
- Расширение метрик Prometheus.
- Создание специализированных дашбордов Grafana.
- Разработка инструментов для анализа аномалий.
- Написание документации.

**Продолжительность**: 3-4 месяца

### Тема 3: Анализ безопасности

**Название**: "Анализ безопасности реализации протокола MASQUE CONNECT-IP"

**Объем работ**:
- Аудит безопасности кода.
- Анализ безопасности протокола.
- Тестирование на проникновение.
- Рекомендации по безопасности.

**Продолжительность**: 4-5 месяцев

## Лучшие практики

### Тестирование

- Всегда сначала тестируйте в изолированной среде.
- Используйте эмуляцию сети для получения воспроизводимых результатов.
- Документируйте все изменения конфигурации.
- Ведите подробные журналы.

### Сбор данных

- Собирайте базовые измерения перед внесением изменений.
- Проводите несколько итераций тестов для статистической значимости.
- Фиксируйте все факторы окружающей среды.
- Используйте единую методику тестирования.

### Документация

- Документируйте все эксперименты.
- Прикладывайте файлы конфигурации.
- Сохраняйте сырые данные для последующего анализа.
- Создавайте понятные графики и диаграммы.

## Устранение неполадок

### Частые проблемы

**Ошибки сертификатов**:
- Проверьте, что CA и сертификаты сгенерированы правильно.
- Проверьте пути к сертификатам в конфигурации.
- Убедитесь, что срок действия сертификатов не истек.

**Проблемы с правами доступа**:
- Создание устройства TUN требует прав root/администратора.
- Используйте `sudo` при запуске сервера и клиента.

**Ошибки подключения**:
- Проверьте настройки брандмауэра (firewall).
- Убедитесь, что сервер прослушивает правильный порт.
- Убедитесь, что клиент использует правильный адрес сервера.

**Проблемы с производительностью**:
- Проверьте настройки MTU.
- Проверьте состояние сети.
- Отслеживайте системные ресурсы (CPU, RAM).

## Дополнительные ресурсы

- [Обзор архитектуры](../architecture/overview.ru.md)
- [Настройка мониторинга](../monitoring/setup.ru.md)
- [RFC 9484 (MASQUE)](https://datatracker.ietf.org/doc/html/rfc9484)
- [RFC 9000 (QUIC)](https://datatracker.ietf.org/doc/html/rfc9000)

## Поддержка

Для вопросов и сотрудничества:
- Оригинальный репозиторий: [iselt/masque-vpn](https://github.com/iselt/masque-vpn)
- Обсуждения и вопросы на GitHub
- Образовательные учреждения могут форкать и адаптировать проект
- Приветствуются исследовательские работы и публикации
