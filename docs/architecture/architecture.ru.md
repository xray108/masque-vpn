# Архитектура masque-vpn

Этот документ описывает высокоуровневую архитектуру проекта masque-vpn, реализующего протокол MASQUE (CONNECT-IP) поверх HTTP/3 (QUIC).

## Компоненты системы

Система состоит из трех основных компонентов:

1.  **VPN Сервер (`vpn_server`)**:
    *   Принимает входящие QUIC соединения от клиентов.
    *   Аутентифицирует клиентов с помощью mTLS (взаимная TLS аутентификация).
    *   Управляет IP-адресацией внутри VPN-сети.
    *   Пересылает пакеты между TUN-интерфейсом и QUIC-потоками.
    *   Предоставляет API для управления и метрики Prometheus.

2.  **VPN Клиент (`vpn_client`)**:
    *   Устанавливает QUIC соединение с сервером.
    *   Создает локальный TUN-интерфейс.
    *   Перехватывает трафик с локального устройства и отправляет его в туннель.
    *   Принимает пакеты из туннеля и записывает их в TUN-интерфейс.

3.  **API Сервер и Веб-интерфейс**:
    *   Встроен в `vpn_server`.
    *   Позволяет администраторам управлять пользователями и конфигурациями.
    *   Генерирует клиентские конфигурации и сертификаты.

## Поток данных (Packet Flow)

### От Клиента к Серверу

1.  Приложение на устройстве клиента отправляет IP-пакет.
2.  ОС маршрутизирует пакет в интерфейс `utun` (созданный `vpn_client`).
3.  `vpn_client` считывает пакет из интерфейса `utun`.
4.  (Опционально) Пакет кодируется с помощью FEC (если включено).
5.  Пакет инкапсулируется в DATAGRAM фрейм HTTP/3.
6.  Пакет отправляется через QUIC соединение на сервер.

### От Сервера к Клиенту

1.  `vpn_server` получает QUIC DATAGRAM.
2.  Извлекает IP-пакет.
3.  (Опционально) Декодирует FEC и восстанавливает потерянные пакеты.
4.  Записывает пакет в свой интерфейс `tun`.
5.  Ядро ОС сервера маршрутизирует пакет в интернет (NAT).

## Ключевые технологии

*   **QUIC (RFC 9000)**: Транспортный протокол на основе UDP, обеспечивающий надежность, безопасность (TLS 1.3) и контроль перегрузки.
*   **HTTP/3 (RFC 9114)**: Протокол прикладного уровня, работающий поверх QUIC.
*   **MASQUE (RFC 9484)**: Расширение HTTP для проксирования IP-трафика. Использует метод `CONNECT-IP`.
*   **TUN/TAP**: Виртуальные сетевые драйверы для перехвата и инъекции пакетов.

## Структура проекта

*   `vpn_server/`: Исходный код сервера.
*   `vpn_client/`: Исходный код клиента.
*   `common/`: Общие библиотеки (конфигурация, утилиты, FEC).
    *   `common/fec/`: Реализация Forward Error Correction.
*   `cert/`: Скрипты для генерации сертификатов.
*   `docs/`: Документация.

## Безопасность

*   **Шифрование**: Весь трафик шифруется с помощью TLS 1.3 (часть QUIC).
*   **Аутентификация**: Используется mTLS. Клиент должен предъявить валидный сертификат, подписанный доверенным CA.
*   **Изоляция**: Каждый клиент получает свой IP-адрес внутри VPN.

## Производительность

*   **User-space Networking**: Обработка пакетов происходит в пространстве пользователя (Go), что может вносить накладные расходы по сравнению с решениями в ядре (WireGuard).
*   **FEC**: Упреждающая коррекция ошибок помогает бороться с потерей пакетов, но увеличивает потребление трафика.
*   **Многопоточность**: Go runtime эффективно распределяет нагрузку по ядрам CPU.
