# Архитектура masque-vpn

Этот документ описывает высокоуровневую архитектуру проекта masque-vpn - учебной реализации протокола MASQUE (CONNECT-IP) поверх HTTP/3 (QUIC) для лабораторных исследований.

## Компоненты системы

Система состоит из четырех основных компонентов:

1.  **VPN Сервер (`vpn_server`)**:
    *   Принимает входящие QUIC соединения от клиентов.
    *   Аутентифицирует клиентов с помощью mTLS (взаимная TLS аутентификация).
    *   Управляет IP-адресацией внутри VPN-сети с помощью пула IP адресов.
    *   Пересылает пакеты между TUN-интерфейсом и QUIC-потоками.
    *   Предоставляет REST API для управления и метрики Prometheus.
    *   Использует структурированное логирование (zap) с различными уровнями.

2.  **VPN Клиент (`vpn_client`)**:
    *   Устанавливает QUIC соединение с сервером.
    *   Создает локальный TUN-интерфейс (опционально).
    *   Перехватывает трафик с локального устройства и отправляет его в туннель.
    *   Принимает пакеты из туннеля и записывает их в TUN-интерфейс.
    *   Поддерживает работу без TUN устройства для тестирования.

3.  **REST API Сервер**:
    *   Встроен в `vpn_server` как отдельный HTTP сервер.
    *   Предоставляет endpoints для управления клиентами и мониторинга.
    *   Работает на отдельном порту (по умолчанию 8080).
    *   Поддерживает JSON API для интеграции с внешними системами.

4.  **Общие библиотеки (`common`)**:
    *   Кастомная реализация MASQUE CONNECT-IP протокола.
    *   Функции для работы с IP пакетами и TUN устройствами.
    *   Централизованная система обработки ошибок.
    *   Конфигурационные структуры и утилиты.

## Поток данных (Packet Flow)

### От Клиента к Серверу

1.  Приложение на устройстве клиента отправляет IP-пакет.
2.  ОС маршрутизирует пакет в интерфейс TUN (если включен).
3.  Клиент считывает пакет из интерфейса TUN.
4.  Пакет инкапсулируется в MASQUE CONNECT-IP запрос.
5.  Пакет отправляется через QUIC stream на сервер.

### От Сервера к Клиенту

1.  Сервер получает пакет через QUIC stream.
2.  Извлекает IP-пакет из MASQUE инкапсуляции.
3.  Записывает пакет в свой интерфейс TUN (если включен).
4.  Ядро ОС сервера маршрутизирует пакет в интернет (NAT).

### Особенности реализации

*   **Работа без TUN**: Система может работать без TUN устройств для тестирования протокола.
*   **Кастомная реализация MASQUE**: Используется собственная реализация протокола вместо внешних библиотек.
*   **Двунаправленная передача**: Поддерживается одновременная передача данных в обе стороны.

## Ключевые технологии

*   **QUIC (RFC 9000)**: Транспортный протокол на основе UDP, обеспечивающий надежность, безопасность (TLS 1.3) и контроль перегрузки.
*   **HTTP/3 (RFC 9114)**: Протокол прикладного уровня, работающий поверх QUIC.
*   **MASQUE (RFC 9484)**: Расширение HTTP для проксирования IP-трафика. Использует метод `CONNECT-IP`.
*   **TUN/TAP**: Виртуальные сетевые драйверы для перехвата и инъекции пакетов.
*   **Go 1.25**: Современная версия языка программирования с улучшенной производительностью.
*   **Structured Logging**: Использование zap для структурированного логирования.
*   **Prometheus Metrics**: Детальные метрики для мониторинга производительности.

## Структура проекта

*   `vpn_server/`: Исходный код сервера.
    *   `internal/server/`: Основная логика сервера, разделенная на модули:
        *   `server.go`: Основной сервер и инициализация.
        *   `api_server.go`: REST API сервер для управления.
        *   `masque_handler.go`: Обработчик MASQUE CONNECT-IP запросов.
        *   `packet_processor.go`: Обработка пакетов TUN устройства.
        *   `metrics.go`: Метрики Prometheus.
        *   `tls_config.go`: Конфигурация TLS.
    *   `main.go`: Точка входа, инициализация и запуск.
*   `vpn_client/`: Исходный код клиента.
*   `common/`: Общие библиотеки:
    *   `masque_connectip.go`: Кастомная реализация MASQUE CONNECT-IP.
    *   `masque_proxy.go`: Функции проксирования IP пакетов.
    *   `errors.go`: Централизованная система обработки ошибок.
    *   `config.go`: Конфигурационные структуры.
    *   `ip.go`: Утилиты для работы с IP адресами.
*   `cert/`: Скрипты для генерации сертификатов.
*   `docs/`: Документация проекта.
*   `tests/`: Комплексные тесты (unit, integration, load).
*   `scripts/`: Скрипты автоматизации тестирования.

## Безопасность

*   **Шифрование**: Весь трафик шифруется с помощью TLS 1.3 (часть QUIC).
*   **Аутентификация**: Используется mTLS. Клиент должен предъявить валидный сертификат, подписанный доверенным CA.
*   **Изоляция**: Каждый клиент получает свой IP-адрес внутри VPN.

## Производительность

*   **User-space Networking**: Обработка пакетов происходит в пространстве пользователя (Go).
*   **Concurrency Optimization**: Используется `sync.RWMutex` для защиты таблиц маршрутизации, что позволяет параллельно обрабатывать пакеты на чтение без блокировок.
*   **Модульная архитектура**: Разделение сервера на независимые модули улучшает производительность и поддерживаемость.
*   **Многопоточность**: Go runtime эффективно распределяет нагрузку по ядрам CPU.
*   **Детальные метрики**: Prometheus метрики позволяют отслеживать производительность в реальном времени.

## Особенности учебной версии

*   **Упрощенная аутентификация**: Базовая проверка сертификатов без сложных схем авторизации.
*   **Отладочные возможности**: Подробное логирование и возможность работы без TUN устройств.
*   **Тестовые конфигурации**: Готовые конфигурации для локального тестирования.
*   **Комплексное тестирование**: Unit, integration и load тесты для изучения поведения системы.
*   **Документированный код**: Подробные комментарии для понимания реализации протокола.
